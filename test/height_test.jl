using ForestBiometrics
using DelimitedFiles


datapath = joinpath(@__DIR__, "data")
data=readdlm(joinpath(datapath,"IEsubset_Data_CSV.csv"),',',header=true)

tl = Tree[]

for i in eachrow(data[1])
    push!(tl,Tree(i[10], missing, i[9], i[7]))
end

# 2 parameter Wyckoff coefficients. Default values for IE variant of FVS
FVS_IE=Dict{String,Array{Float64}}(
"WP"=>[5.19988	-9.26718],
"WL"=>[4.97407	-6.78347],
"DF"=>[4.81519	-7.29306],
"GF"=>[5.00233	-8.19365],
"WH"=>[4.97331	-8.19730],
"RC"=>[4.89564	-8.39057],
"LP"=>[4.62171	-5.32481],
"ES"=>[4.9219	-8.30289],
"AF"=>[4.76537	-7.61062],
"PP"=>[4.9288	-9.32795],
"MH"=>[4.77951	-9.31743],
"WB"=>[4.97407	-6.78347],
"LM"=>[4.19200	-5.16510],
"LL"=>[4.76537	-7.61062],
"PI"=>[3.20000	-5.00000],
"RM"=>[3.20000	-5.00000],
"PY"=>[4.19200	-5.16510],
"AS"=>[4.44210	-6.54050],
"CO"=>[4.44210	-6.54050],
"MM"=>[4.44210	-6.54050],
"PB"=>[4.44210	-6.54050],
"OH"=>[4.44210	-6.54050],
"OS"=>[4.77951	-9.31743] )

#using Wyckoff=(x,b)->4.5+exp(b[1]+(b[2]/(x+1)))
wyk = HeightModel(wyckoff,FVS_IE)

wyckoff_out= [estimate_height(i,wyk) for i in tl]

wyckoff_test=[
100.3704728
61.35043145
11.31948442
11.99184897
71.56773647
75.48849752
4.662859967
38.1318738
86.57926895
89.09331657
83.29702964
82.02991682
59.36359424
92.24130804
80.79924609
95.99589413
89.52703552
73.04225223
95.88342114
59.38502782
4.662859967
4.662859967
97.69440543
96.76176795
106.4984871
75.82474076
100.3704728
105.4603241
92.79168745
78.84582366
79.6182448
77.22661356
92.79168745
86.208065]

@test isapprox(wyckoff_out, wyckoff_test)

#test custom function
p2=HeightModel((x,b)->4.5+x^b[1]^b[2],FVS_IE)

user_eq_out = [estimate_height(i,p2) for i in tl]

user_eq_test=[
5.50000110437066
5.50000077727861
5.50000025616043
5.50000027222188
5.50000085504705
5.50000088557174
5.49997579696978
5.50000059480051
5.50000097615539
5.50000099792679
5.50000094851992
5.50002825335774
5.50002185801763
5.50003169790446
5.50000092800344
5.50003314012292
5.50000100174185
5.50000086646161
5.50003309510479
5.50000076242647
5.49997579696978
5.49997579696978
5.50003383536612
5.50003344996446
5.50000117082406
5.50000088821741
5.50000110437066
5.50000115899896
5.50003190202163
5.50002728005371
5.50002751279364
5.50002679851972
5.50003190202163
5.50002959423972]

@test isapprox(user_eq_out, user_eq_test)
#end test 2

